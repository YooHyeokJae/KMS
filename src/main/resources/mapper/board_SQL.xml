<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hj.mapper.BoardMapper">

    <select id="getTotal" resultType="int">
        SELECT COUNT(*) FROM BOARD WHERE CATEGORY = #{cat} AND DEL_YN = 'N'
    </select>

    <select id="getList" resultType="com.hj.vo.BoardVo">
        SELECT BOARD.*, USER.NAME AS WRITER_NAME, ATTACH_FILE.FILE_SIZE AS FILE_SIZE
        FROM BOARD
            LEFT JOIN ATTACH_FILE ON(CONCAT('board/', BOARD.NUM) = ATTACH_FILE.GLOBAL_CODE AND ATTACH_FILE.DEL_YN = 'N')
            LEFT JOIN USER ON (BOARD.WRITER_ID = USER.ID AND USER.DEL_YN = 'N')
        WHERE CATEGORY = #{cat}
          AND BOARD.DEL_YN = 'N'
        ORDER BY BOARD.REG_DATE DESC LIMIT #{start}, #{count}
    </select>

    <select id="getNextNum" resultType="int">
        SELECT MAX(NUM)+1 FROM BOARD
    </select>

    <insert id="insertBoard">
        INSERT INTO BOARD(NUM, CATEGORY, TITLE, CONTENT, WRITER_ID) VALUES(#{num}, #{category}, #{title}, #{content}, #{writerId})
    </insert>

    <update id="viewBoard">
        UPDATE BOARD SET VIEW_CNT = VIEW_CNT + 1 WHERE NUM = #{num}
    </update>

    <select id="getBoardByNum" resultType="com.hj.vo.BoardVo">
        SELECT BOARD.*, USER.NAME AS WRITER_NAME
        FROM BOARD
        LEFT JOIN USER ON (BOARD.WRITER_ID = USER.ID AND USER.DEL_YN = 'N')
        WHERE NUM = #{num}
    </select>

    <select id="getReplyListByBoardNum" resultType="com.hj.vo.ReplyVo">
        SELECT REPLY.*, USER.NAME AS WRITER_NAME
        FROM REPLY
        LEFT JOIN USER ON (REPLY.WRITER_ID = USER.ID AND USER.DEL_YN = 'N')
        WHERE BOARD_NUM = #{boardNum} AND REPLY.DEL_YN = 'N'
        ORDER BY REG_DATE DESC
    </select>

    <insert id="insertReply">
        INSERT INTO REPLY(BOARD_NUM, CONTENT, WRITER_ID) VALUES(#{boardNum}, #{content}, #{writerId})
    </insert>

    <select id="getPrev" resultType="com.hj.vo.BoardVo">
        SELECT * FROM BOARD WHERE NUM <![CDATA[ < ]]> #{num} AND CATEGORY = #{category} ORDER BY REG_DATE DESC LIMIT 1
    </select>

    <select id="getNext" resultType="com.hj.vo.BoardVo">
        SELECT * FROM BOARD WHERE NUM <![CDATA[ > ]]> #{num} AND CATEGORY = #{category} LIMIT 1
    </select>

    <update id="modifyBoard">
        UPDATE BOARD SET CATEGORY = #{category}, TITLE = #{title}, CONTENT = <![CDATA[ #{content} ]]>, UPD_DATE = SYSDATE() WHERE NUM = #{num}
    </update>

    <update id="deleteBoard">
        UPDATE BOARD SET DEL_YN = 'Y', UPD_DATE = SYSDATE() WHERE NUM = #{num}
    </update>

    <select id="getBestByDateOrViewOrLike" resultType="com.hj.vo.BoardVo">
        SELECT BOARD.*, USER.NAME AS WRITER_NAME
        FROM BOARD
        LEFT JOIN USER ON (BOARD.WRITER_ID = USER.ID AND USER.DEL_YN = 'N')
        WHERE BOARD.DEL_YN = 'N'
          AND BOARD.CATEGORY = #{category}
        <if test="order eq 'date'">
            ORDER BY BOARD.REG_DATE DESC LIMIT #{count}
        </if>
        <if test="order eq 'view'">
            ORDER BY BOARD.VIEW_CNT DESC LIMIT #{count}
        </if>
        <if test="order eq 'like'">
            ORDER BY BOARD.LIKE_CNT DESC LIMIT #{count}
        </if>
    </select>
</mapper>